

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>uuv_control_interfaces.dp_controller_local_planner &mdash; UUV Simulator 0.2 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="UUV Simulator 0.2 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> UUV Simulator
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">F.A.Q.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">UUV Simulator</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>uuv_control_interfaces.dp_controller_local_planner</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for uuv_control_interfaces.dp_controller_local_planner</h1><div class="highlight"><pre>
<span class="c1"># Copyright (c) 2016 The UUV Simulator Authors.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isfile</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Float64</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="nn">uuv_control_msgs.srv</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">uuv_control_msgs.msg</span> <span class="kn">import</span> <span class="n">Trajectory</span><span class="p">,</span> <span class="n">TrajectoryPoint</span><span class="p">,</span> <span class="n">WaypointSet</span>
<span class="kn">from</span> <span class="nn">visualization_msgs.msg</span> <span class="kn">import</span> <span class="n">MarkerArray</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Point</span>
<span class="kn">import</span> <span class="nn">uuv_trajectory_generator</span>
<span class="kn">import</span> <span class="nn">uuv_waypoints</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tf2_ros</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">tf.transformations</span> <span class="kn">import</span> <span class="n">quaternion_about_axis</span><span class="p">,</span> <span class="n">quaternion_multiply</span><span class="p">,</span> \
    <span class="n">quaternion_inverse</span><span class="p">,</span> <span class="n">quaternion_matrix</span><span class="p">,</span> <span class="n">euler_from_quaternion</span>


<div class="viewcode-block" id="DPControllerLocalPlanner"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner">[docs]</a><span class="k">class</span> <span class="nc">DPControllerLocalPlanner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Local planner for the dynamic positioning controllers to interpolate</span>
<span class="sd">    trajectories and generate trajectories from interpolated waypoint paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_dof</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stamped_pose_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">thrusters_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;dp_local_planner&#39;</span><span class="p">)</span>
        <span class="n">out_hdlr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">out_hdlr</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">get_namespace</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; -- </span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)s</span><span class="s1"> | </span><span class="si">%(module)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">out_hdlr</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">out_hdlr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span> <span class="o">=</span> <span class="n">uuv_trajectory_generator</span><span class="o">.</span><span class="n">TrajectoryGenerator</span><span class="p">(</span>
            <span class="n">full_dof</span><span class="o">=</span><span class="n">full_dof</span><span class="p">,</span> <span class="n">stamped_pose_only</span><span class="o">=</span><span class="n">stamped_pose_only</span><span class="p">)</span>

        <span class="c1"># Max. allowed forward speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~max_forward_speed&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idle_z</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Max. forward speed [m/s]=</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_idle_radius</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~idle_radius&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idle_radius</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Idle circle radius [m] = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idle_radius</span><span class="p">)</span>

        <span class="c1"># Is underactuated?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_underactuated</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~is_underactuated&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span> <span class="o">=</span> <span class="s1">&#39;world&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_ned_to_enu</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~inertial_frame_id&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~inertial_frame_id&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;world_ned&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inertial frame ID=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s1">&#39;inertial_frame_id&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>

        <span class="n">tf_buffer</span> <span class="o">=</span> <span class="n">tf2_ros</span><span class="o">.</span><span class="n">Buffer</span><span class="p">()</span>
        <span class="n">listener</span> <span class="o">=</span> <span class="n">tf2_ros</span><span class="o">.</span><span class="n">TransformListener</span><span class="p">(</span><span class="n">tf_buffer</span><span class="p">)</span>
        <span class="n">tf_trans_ned_to_enu</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tf_trans_ned_to_enu</span> <span class="o">=</span> <span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
                <span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;world_ned&#39;</span><span class="p">,</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(),</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tf_trans_ned_to_enu</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No transform found between world and the &#39;</span>
                               <span class="s1">&#39;inertial_frame_id provided &#39;</span> <span class="o">+</span>
                               <span class="n">rospy</span><span class="o">.</span><span class="n">get_namespace</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">tf_trans_ned_to_enu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform_ned_to_enu</span> <span class="o">=</span> <span class="n">quaternion_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="n">tf_trans_ned_to_enu</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                 <span class="n">tf_trans_ned_to_enu</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                 <span class="n">tf_trans_ned_to_enu</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                 <span class="n">tf_trans_ned_to_enu</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">w</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Transform world_ned (NED) to world (ENU)=</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_ned_to_enu</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inertial frame ID=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Max. forward speed = &#39;</span> <span class="o">+</span>
                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_interpolator_tags</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="n">method</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parameters for interpolation method &lt;</span><span class="si">%s</span><span class="s1">&gt; found&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="n">method</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_interpolator_parameters</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No parameters for interpolation method &lt;</span><span class="si">%s</span><span class="s1">&gt; found&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

        <span class="c1"># dt used to compute the pose reference from the joystick input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Time stamp for the last velocity reference received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_teleop_update</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># Flag to indicate if the teleoperation node is active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_teleop_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># Teleop node twist message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_odom_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_odom_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_idle_mode</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~timeout_idle_mode&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_count_idle</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_thrusters_only</span> <span class="o">=</span> <span class="n">thrusters_only</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thrusters_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_look_ahead_delay</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~look_ahead_delay&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_look_ahead_delay</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_center</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Publishing topic for the trajectory given to the controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;trajectory&#39;</span><span class="p">,</span>
                                               <span class="n">Trajectory</span><span class="p">,</span>
                                               <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Publishing waypoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waypoints_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;waypoints&#39;</span><span class="p">,</span>
                                               <span class="n">WaypointSet</span><span class="p">,</span>
                                               <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;station_keeping_on&#39;</span><span class="p">,</span>
                                                    <span class="n">Bool</span><span class="p">,</span>
                                                    <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_automatic_control_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;automatic_on&#39;</span><span class="p">,</span>
                                                      <span class="n">Bool</span><span class="p">,</span>
                                                      <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_tracking_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;trajectory_tracking_on&#39;</span><span class="p">,</span>
                                                  <span class="n">Bool</span><span class="p">,</span>
                                                  <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_interp_visual_markers</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;interpolator_visual_markers&#39;</span><span class="p">,</span>
                                                      <span class="n">MarkerArray</span><span class="p">,</span>
                                                      <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s1">&#39;cmd_vel&#39;</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_teleop</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_waypoints_msg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_msg</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Subscribing topic for the trajectory given to the controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_trajectory_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span>
            <span class="s1">&#39;input_trajectory&#39;</span><span class="p">,</span> <span class="n">Trajectory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_from_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_time_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;time_to_target&#39;</span><span class="p">,</span> <span class="n">Float64</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_info_update_timer</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_trajectory_info</span><span class="p">)</span>
        <span class="c1"># Flag to activate station keeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_on</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Flag to set vehicle control to automatic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_automatic</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Flag true if a trajectory is being tracked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># Current vehicle pose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># Current reference point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># Flag that indicates that a waypoint set has been initialized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># Time stamp for received trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_trajectory_received</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Dictionary of services</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;hold_vehicle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
            <span class="s1">&#39;hold_vehicle&#39;</span><span class="p">,</span> <span class="n">Hold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_vehicle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;start_waypoint_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
            <span class="s1">&#39;start_waypoint_list&#39;</span><span class="p">,</span> <span class="n">InitWaypointSet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_waypoint_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;start_circular_trajectory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
            <span class="s1">&#39;start_circular_trajectory&#39;</span><span class="p">,</span> <span class="n">InitCircularTrajectory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_circle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;start_helical_trajectory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
            <span class="s1">&#39;start_helical_trajectory&#39;</span><span class="p">,</span> <span class="n">InitHelicalTrajectory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_helix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;init_waypoints_from_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
            <span class="s1">&#39;init_waypoints_from_file&#39;</span><span class="p">,</span> <span class="n">InitWaypointsFromFile</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_waypoints_from_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;go_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span><span class="s1">&#39;go_to&#39;</span><span class="p">,</span> <span class="n">GoTo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">go_to</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;go_to_incremental&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
            <span class="s1">&#39;go_to_incremental&#39;</span><span class="p">,</span> <span class="n">GoToIncremental</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">go_to_incremental</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove logging message handlers&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_transform_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vec</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;world&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_ned_to_enu</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;world_ned&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_ned_to_enu</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transform_waypoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waypoint</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">waypoint</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_position</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">,</span>
                                              <span class="n">output</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">inertial_frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span>
        <span class="n">output</span><span class="o">.</span><span class="n">max_forward_speed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_transform_waypoint_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waypoint_set</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">WaypointSet</span><span class="p">(</span>
            <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">waypoint_set</span><span class="o">.</span><span class="n">num_waypoints</span><span class="p">):</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_waypoint</span><span class="p">(</span><span class="n">waypoint_set</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">output</span><span class="o">.</span><span class="n">add_waypoint</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_apply_workspace_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waypoint_set</span><span class="p">):</span>
        <span class="n">wp_set</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">WaypointSet</span><span class="p">(</span>
            <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">waypoint_set</span><span class="o">.</span><span class="n">num_waypoints</span><span class="p">):</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="n">waypoint_set</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wp</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span> <span class="o">==</span> <span class="s1">&#39;world&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">wp</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span> <span class="o">==</span> <span class="s1">&#39;world_ned&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">wp_set</span><span class="o">.</span><span class="n">add_waypoint</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wp_set</span>

    <span class="k">def</span> <span class="nf">_publish_trajectory_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish messages for the waypoints, trajectory and internal flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waypoints_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_waypoints_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_waypoints_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_msg</span><span class="p">)</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_visual_markers</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">markers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interp_visual_markers</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interp_visual_markers</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">MarkerArray</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_on</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_automatic_control_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_automatic</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_tracking_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_running</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_update_trajectory_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waypoints_msg</span> <span class="o">=</span> <span class="n">WaypointSet</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">is_using_waypoints</span><span class="p">():</span>
            <span class="n">wps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">wps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">wps</span><span class="o">.</span><span class="n">inertial_frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_waypoints_msg</span> <span class="o">=</span> <span class="n">wps</span><span class="o">.</span><span class="n">to_message</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_waypoints_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_trajectory_as_message</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_msg</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating the trajectory information&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory_msg</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error generating trajectory message&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_teleop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback to the twist teleop subscriber.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Test whether the vehicle is in automatic mode (following a given</span>
        <span class="c1"># trajectory)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_automatic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span>

        <span class="c1"># If this is the first twist message since the last time automatic mode</span>
        <span class="c1"># was turned off, then just update the teleop timestamp and wait for</span>
        <span class="c1"># the next message to allow computing pose and velocity reference.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_teleop_update</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_teleop_update</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Store twist reference message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span> <span class="o">=</span> <span class="n">msg</span>

        <span class="c1"># Set the teleop mode is active only if any of the linear velocity components and</span>
        <span class="c1"># yaw rate are non-zero</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_teleop_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Store time stamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_teleop_update</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calc_teleop_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute pose and velocity reference using the joystick linear and</span>
<span class="sd">        angular velocity input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if there is already a timestamp for the last received reference</span>
        <span class="c1"># message from the teleop node</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_teleop_update</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_teleop_active</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Compute time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_teleop_update</span>

        <span class="c1"># Compute the pose and velocity reference if the computed time step is</span>
        <span class="c1"># positive and the twist teleop message is valid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
            <span class="c1"># Cap the forward speed if needed</span>
            <span class="k">if</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span><span class="p">:</span>
                <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span> <span class="o">/</span> <span class="n">speed</span>
                <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span> <span class="o">/</span> <span class="n">speed</span>

            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">rot_matrix</span><span class="p">,</span> <span class="n">vel</span><span class="p">)</span>

            <span class="c1"># Compute pose step</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">uuv_trajectory_generator</span><span class="o">.</span><span class="n">TrajectoryPoint</span><span class="p">()</span>
            <span class="n">step</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">rot_matrix</span><span class="p">,</span> <span class="n">vel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">rotq</span> <span class="o">=</span> <span class="n">quaternion_about_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Compute new reference</span>
            <span class="n">ref_pnt</span> <span class="o">=</span> <span class="n">uuv_trajectory_generator</span><span class="o">.</span><span class="n">TrajectoryPoint</span><span class="p">()</span>
            <span class="n">ref_pnt</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="n">step</span><span class="o">.</span><span class="n">pos</span>

            <span class="n">ref_pnt</span><span class="o">.</span><span class="n">rotq</span> <span class="o">=</span> <span class="n">quaternion_multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">(),</span> <span class="n">step</span><span class="o">.</span><span class="n">rotq</span><span class="p">)</span>

            <span class="c1"># Cap the pose reference in Z to stay underwater</span>
            <span class="k">if</span> <span class="n">ref_pnt</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ref_pnt</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">ref_pnt</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="p">[</span><span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_pnt</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="p">[</span><span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teleop_vel_ref</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>

            <span class="n">ref_pnt</span><span class="o">.</span><span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_teleop_active</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ref_pnt</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ref_pnt</span>

    <span class="k">def</span> <span class="nf">_calc_smooth_approach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the current vehicle position as waypoint to allow a smooth</span>
<span class="sd">        approach to the given trajectory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Simulation not properly initialized yet, ignoring approach...&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">is_using_waypoints</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Not using the waypoint interpolation method&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">heading</span> <span class="o">=</span> <span class="n">euler_from_quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">())[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thrusters_only</span><span class="p">:</span>
            <span class="n">init_wp</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">Waypoint</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">max_forward_speed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">,</span>
                <span class="n">heading_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">heading_offset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max_forward_speed</span>
            <span class="n">init_wp</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">Waypoint</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="c1"># + max_speed / self._look_ahead_delay * np.cos(heading),</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="c1"># + max_speed / self._look_ahead_delay * np.sin(heading),</span>
                <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">max_forward_speed</span><span class="o">=</span><span class="n">max_speed</span><span class="p">,</span>
                <span class="n">heading_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">heading_offset</span><span class="p">)</span>
        <span class="n">first_wp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">first_wp</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">init_wp</span><span class="o">.</span><span class="n">x</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">first_wp</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">init_wp</span><span class="o">.</span><span class="n">y</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">first_wp</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">init_wp</span><span class="o">.</span><span class="n">z</span>

        <span class="c1"># One new waypoint at each meter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding waypoints to approach the first position in the given waypoint set&#39;</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">first_wp</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">init_wp</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_interp_method</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;dubins&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
                <span class="n">wp</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">Waypoint</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">first_wp</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">steps</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">first_wp</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">steps</span><span class="p">,</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">first_wp</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">steps</span><span class="p">,</span>
                    <span class="n">max_forward_speed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">add_waypoint</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="n">add_to_beginning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">add_waypoint</span><span class="p">(</span><span class="n">init_wp</span><span class="p">,</span> <span class="n">add_to_beginning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>

<div class="viewcode-block" id="DPControllerLocalPlanner.is_station_keeping_on"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.is_station_keeping_on">[docs]</a>    <span class="k">def</span> <span class="nf">is_station_keeping_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_on</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.is_automatic_on"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.is_automatic_on">[docs]</a>    <span class="k">def</span> <span class="nf">is_automatic_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_automatic</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.set_station_keeping"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.set_station_keeping">[docs]</a>    <span class="k">def</span> <span class="nf">set_station_keeping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_on</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set station keeping mode flag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_on</span> <span class="o">=</span> <span class="n">is_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;STATION KEEPING MODE = &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;ON&#39;</span> <span class="k">if</span> <span class="n">is_on</span> <span class="k">else</span> <span class="s1">&#39;OFF&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.set_automatic_mode"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.set_automatic_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_automatic_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_on</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set automatic mode flag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_automatic</span> <span class="o">=</span> <span class="n">is_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;AUTOMATIC MODE = &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;ON&#39;</span> <span class="k">if</span> <span class="n">is_on</span> <span class="k">else</span> <span class="s1">&#39;OFF&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.set_trajectory_running"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.set_trajectory_running">[docs]</a>    <span class="k">def</span> <span class="nf">set_trajectory_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_on</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set trajectory tracking flag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_running</span> <span class="o">=</span> <span class="n">is_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;TRAJECTORY TRACKING = &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;ON&#39;</span> <span class="k">if</span> <span class="n">is_on</span> <span class="k">else</span> <span class="s1">&#39;OFF&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.has_started"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.has_started">[docs]</a>    <span class="k">def</span> <span class="nf">has_started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return if the trajectory interpolator has started generating reference</span>
<span class="sd">        points.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">has_started</span><span class="p">()</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.has_finished"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.has_finished">[docs]</a>    <span class="k">def</span> <span class="nf">has_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">has_finished</span><span class="p">()</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.update_vehicle_pose"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.update_vehicle_pose">[docs]</a>    <span class="k">def</span> <span class="nf">update_vehicle_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span> <span class="o">=</span> <span class="n">uuv_trajectory_generator</span><span class="o">.</span><span class="n">TrajectoryPoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">rotq</span> <span class="o">=</span> <span class="n">quat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_odom_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.get_vehicle_rot"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.get_vehicle_rot">[docs]</a>    <span class="k">def</span> <span class="nf">get_vehicle_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_odom_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">rotq</span></div>

    <span class="k">def</span> <span class="nf">_update_trajectory_from_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_trajectory_received</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">init_from_trajectory_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New trajectory received at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stamp_trajectory_received</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>

<div class="viewcode-block" id="DPControllerLocalPlanner.start_station_keeping"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.start_station_keeping">[docs]</a>    <span class="k">def</span> <span class="nf">start_station_keeping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span><span class="o">.</span><span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.hold_vehicle"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.hold_vehicle">[docs]</a>    <span class="k">def</span> <span class="nf">hold_vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Service callback function to hold the vehicle&#39;s current position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Current pose of the vehicle is invalid&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HoldResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_station_keeping</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HoldResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.start_waypoint_list"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.start_waypoint_list">[docs]</a>    <span class="k">def</span> <span class="nf">start_waypoint_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">waypoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Waypoint list is empty&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InitWaypointSet</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">InitWaypointSet</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.start_circle"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.start_circle">[docs]</a>    <span class="k">def</span> <span class="nf">start_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">max_forward_speed</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">radius</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> \
           <span class="n">request</span><span class="o">.</span><span class="n">n_points</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid parameters to generate a circular trajectory&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InitCircularTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">secs</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nsecs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">start_now</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The trajectory starts in the past, correct the starting time!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InitCircularTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">wp_set</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">WaypointSet</span><span class="p">(</span>
                <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">wp_set</span><span class="o">.</span><span class="n">generate_circle</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
                                             <span class="n">center</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                                             <span class="n">num_points</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">n_points</span><span class="p">,</span>
                                             <span class="n">max_forward_speed</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">,</span>
                                             <span class="n">theta_offset</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">angle_offset</span><span class="p">,</span>
                                             <span class="n">heading_offset</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">heading_offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error generating circular trajectory from waypoint set&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">InitCircularTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">wp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_workspace_constraints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wp_set</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Waypoints violate workspace constraints, are you using world or world_ned as reference?&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">InitCircularTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="c1"># Activates station keeping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_interp_method</span><span class="p">(</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_waypoints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_center</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_start_time</span><span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">start_now</span> <span class="k">else</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_duration</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">duration</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting a maximum duration, duration=</span><span class="si">%.2f</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting maximum duration failed&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>
            <span class="c1"># Disables station keeping to start trajectory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CIRCULAR TRAJECTORY GENERATED FROM WAYPOINT INTERPOLATION&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Radius [m] = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Center [m] = (</span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# of points = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">n_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Max. forward speed = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Circle angle offset = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">angle_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Heading offset = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">heading_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# waypoints = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">num_waypoints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting from = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting time [s] = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">start_now</span> <span class="k">else</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">InitCircularTrajectoryResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error while setting circular trajectory, msg=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">InitCircularTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.start_helix"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.start_helix">[docs]</a>    <span class="k">def</span> <span class="nf">start_helix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">radius</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">n_points</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> \
           <span class="n">request</span><span class="o">.</span><span class="n">n_turns</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid parameters to generate a helical trajectory&#39;</span><span class="p">)</span>
           <span class="k">return</span> <span class="n">InitHelicalTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">secs</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nsecs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">start_now</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The trajectory starts in the past, correct the starting time!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InitHelicalTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start helical trajectory now!&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">wp_set</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">WaypointSet</span><span class="p">(</span><span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">wp_set</span><span class="o">.</span><span class="n">generate_helix</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
                                            <span class="n">center</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                                            <span class="n">num_points</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">n_points</span><span class="p">,</span>
                                            <span class="n">max_forward_speed</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">,</span>
                                            <span class="n">delta_z</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">delta_z</span><span class="p">,</span>
                                            <span class="n">num_turns</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">n_turns</span><span class="p">,</span>
                                            <span class="n">theta_offset</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">angle_offset</span><span class="p">,</span>
                                            <span class="n">heading_offset</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">heading_offset</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error generating circular trajectory from waypoint set&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">InitHelicalTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">wp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_workspace_constraints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wp_set</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Waypoints violate workspace constraints, are you using world or world_ned as reference?&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">InitHelicalTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_interp_method</span><span class="p">(</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_waypoints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error setting the waypoints&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">InitHelicalTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_center</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_start_time</span><span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">start_now</span> <span class="k">else</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_duration</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">duration</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting a maximum duration, duration=</span><span class="si">%.2f</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting maximum duration failed&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;HELICAL TRAJECTORY GENERATED FROM WAYPOINT INTERPOLATION&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Radius [m] = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Center [m] = (</span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%.2f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# of points = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">n_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Max. forward speed = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Delta Z = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">delta_z</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# of turns = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">n_turns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Helix angle offset = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">angle_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Heading offset = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">heading_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# waypoints = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">num_waypoints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting from = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting time [s] = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">start_now</span> <span class="k">else</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">InitHelicalTrajectoryResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error while setting helical trajectory, msg=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">InitHelicalTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.init_waypoints_from_file"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.init_waypoints_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">init_waypoints_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid waypoint file&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InitWaypointsFromFileResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">secs</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nsecs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">start_now</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The trajectory starts in the past, correct the starting time!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InitHelicalTrajectoryResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start waypoint trajectory now!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_interp_method</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">interpolator</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">wp_set</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">WaypointSet</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wp_set</span><span class="o">.</span><span class="n">read_from_file</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Error occurred while parsing waypoint file&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">InitWaypointsFromFileResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">wp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_waypoint_set</span><span class="p">(</span><span class="n">wp_set</span><span class="p">)</span>
        <span class="n">wp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_workspace_constraints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_waypoints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">()):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">start_now</span> <span class="k">else</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_center</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_start_time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IMPORT WAYPOINTS FROM FILE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filename = &#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Interpolator = &#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">interpolator</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# waypoints = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">num_waypoints</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting time = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inertial frame ID = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">InitWaypointsFromFileResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error occurred while parsing waypoint file&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">InitWaypointsFromFileResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.go_to"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.go_to">[docs]</a>    <span class="k">def</span> <span class="nf">go_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Current pose has not been initialized yet&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">GoToResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">waypoint</span><span class="o">.</span><span class="n">max_forward_speed</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Max. forward speed must be greater than zero&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">GoToResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">wp_set</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">WaypointSet</span><span class="p">(</span>
            <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>

        <span class="n">init_wp</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">Waypoint</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">max_forward_speed</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">waypoint</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">,</span>
            <span class="n">heading_offset</span><span class="o">=</span><span class="n">euler_from_quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">())[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">use_fixed_heading</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">waypoint</span><span class="o">.</span><span class="n">use_fixed_heading</span><span class="p">,</span>
            <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="n">wp_set</span><span class="o">.</span><span class="n">add_waypoint</span><span class="p">(</span><span class="n">init_wp</span><span class="p">)</span>
        <span class="n">wp_set</span><span class="o">.</span><span class="n">add_waypoint_from_msg</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">waypoint</span><span class="p">)</span>
        <span class="n">wp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_waypoint_set</span><span class="p">(</span><span class="n">wp_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_interp_method</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">interpolator</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_waypoints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error while setting waypoints&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">GoToResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_center</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_start_time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GO TO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Heading offset [rad] = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">waypoint</span><span class="o">.</span><span class="n">heading_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# waypoints = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">num_waypoints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting from = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_waypoints</span><span class="p">()</span><span class="o">.</span><span class="n">get_waypoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start time [s] = </span><span class="si">%.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inertial frame ID = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">GoToResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.go_to_incremental"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.go_to_incremental">[docs]</a>    <span class="k">def</span> <span class="nf">go_to_incremental</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Service callback to set the command to the vehicle to move to a</span>
<span class="sd">        relative position in the world.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Current pose has not been initialized yet&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">GoToIncrementalResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">max_forward_speed</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Max. forward speed must be positive&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">GoToIncrementalResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">wp_set</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">WaypointSet</span><span class="p">(</span>
            <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="n">init_wp</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">Waypoint</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">max_forward_speed</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">,</span>
            <span class="n">heading_offset</span><span class="o">=</span><span class="n">euler_from_quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">())[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="n">wp_set</span><span class="o">.</span><span class="n">add_waypoint</span><span class="p">(</span><span class="n">init_wp</span><span class="p">)</span>

        <span class="n">wp</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">Waypoint</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
            <span class="n">max_forward_speed</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">max_forward_speed</span><span class="p">,</span>
            <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="n">wp_set</span><span class="o">.</span><span class="n">add_waypoint</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_interp_method</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">interpolator</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_waypoints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error while setting waypoints&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">GoToIncrementalResponse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_center</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_start_time</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_sec</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GO TO INCREMENTAL&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">wp_set</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# waypoints = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">wp_set</span><span class="o">.</span><span class="n">num_waypoints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inertial frame ID = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">GoToIncrementalResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.generate_reference"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.generate_reference">[docs]</a>    <span class="k">def</span> <span class="nf">generate_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">generate_reference</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">pnt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pnt</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.get_idle_circle_path"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.get_idle_circle_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_idle_circle_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pose</span><span class="o">.</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pose</span><span class="o">.</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pose</span><span class="o">.</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pose</span><span class="o">.</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">pose</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span> <span class="o">*</span> <span class="n">frame</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">frame</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_idle_z</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">pose</span><span class="o">.</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">u</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">angle</span><span class="p">:</span> <span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="n">pose</span><span class="o">.</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span>
        <span class="n">vec</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">u_init</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">wp_set</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">WaypointSet</span><span class="p">(</span>
            <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">u_init</span><span class="p">,</span> <span class="n">u_init</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_points</span><span class="p">):</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="n">uuv_waypoints</span><span class="o">.</span><span class="n">Waypoint</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_idle_circle_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
                <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_idle_z</span><span class="p">,</span>
                <span class="n">max_forward_speed</span><span class="o">=</span><span class="mf">0.8</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_forward_speed</span><span class="p">,</span>
                <span class="n">inertial_frame_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inertial_frame_id</span><span class="p">)</span>
            <span class="n">wp_set</span><span class="o">.</span><span class="n">add_waypoint</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wp_set</span></div>

<div class="viewcode-block" id="DPControllerLocalPlanner.interpolate"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.dp_controller_local_planner.DPControllerLocalPlanner.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function interface to the controller. Calls the interpolator to</span>
<span class="sd">        calculate the current trajectory sample or returns a fixed position</span>
<span class="sd">        based on the past odometry measurements for station keeping.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_on</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_running</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span><span class="p">:</span>
                <span class="c1"># Generate extra waypoint before the initial waypoint</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calc_smooth_approach</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding waypoints to approach the given waypoint trajectory&#39;</span><span class="p">)</span>

            <span class="c1"># Get interpolated reference from the reference trajectory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_look_ahead_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_reference</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_look_ahead_delay</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_max_time_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Float64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">get_max_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_running</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_traj_running</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_namespace</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; - Trajectory running&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traj_running</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">has_finished</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_on</span><span class="p">):</span>
                <span class="c1"># Trajectory ended, start station keeping mode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_namespace</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; - Trajectory completed!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># TODO Fix None value coming from the odometry</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_teleop_active</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_teleop_reference</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span><span class="o">.</span><span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_start_count_idle</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_interp_method</span><span class="p">(</span><span class="s1">&#39;lipb&#39;</span><span class="p">)</span>
            <span class="c1"># Use the latest position and heading of the vehicle from the odometry to enter station keeping mode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_teleop_active</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_teleop_reference</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vehicle_pose</span><span class="p">)</span>
            <span class="c1"># Set roll and pitch reference to zero</span>
            <span class="n">yaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span><span class="o">.</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span><span class="o">.</span><span class="n">rot</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yaw</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_on</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_teleop_active</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_teleop_reference</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_time_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Float64</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="c1">#######################################################################</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thrusters_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_teleop_active</span> <span class="ow">and</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_count_idle</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_idle_mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;AUV STATION KEEPING&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_center</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_station_keeping_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span>

                <span class="n">wp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_idle_circle_path</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idle_radius</span><span class="p">)</span>
                <span class="n">wp_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_workspace_constraints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wp_set</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Waypoints violate workspace constraints, are you using world or world_ned as reference?&#39;</span><span class="p">)</span>

                <span class="c1"># Activates station keeping</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_interp_method</span><span class="p">(</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_waypoints</span><span class="p">(</span><span class="n">wp_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vehicle_rot</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_traj_interpolator</span><span class="o">.</span><span class="n">set_start_time</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_trajectory_info</span><span class="p">()</span>
                <span class="c1"># Disables station keeping to start trajectory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_station_keeping</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_mode</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_trajectory_running</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_approach_on</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c1">#######################################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_this_ref_pnt</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, UUV Simulator Authors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>