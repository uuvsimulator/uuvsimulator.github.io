

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>uuv_control_interfaces.vehicle &mdash; UUV Simulator 0.2 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="UUV Simulator 0.2 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> UUV Simulator
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/index.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">F.A.Q.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">UUV Simulator</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>uuv_control_interfaces.vehicle</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for uuv_control_interfaces.vehicle</h1><div class="highlight"><pre>
<span class="c1"># Copyright (c) 2016 The UUV Simulator Authors.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">nav_msgs.msg</span> <span class="kn">import</span> <span class="n">Odometry</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">rospy.numpy_msg</span> <span class="kn">import</span> <span class="n">numpy_msg</span>
<span class="kn">import</span> <span class="nn">tf2_ros</span>
<span class="kn">from</span> <span class="nn">tf.transformations</span> <span class="kn">import</span> <span class="n">quaternion_from_euler</span><span class="p">,</span> <span class="n">euler_from_quaternion</span><span class="p">,</span> \
    <span class="n">quaternion_matrix</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">is_same_transform</span>

<span class="k">try</span><span class="p">:</span> 
    <span class="kn">import</span> <span class="nn">casadi</span>
    <span class="n">casadi_exists</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">casadi_exists</span> <span class="o">=</span> <span class="bp">False</span>


<div class="viewcode-block" id="cross_product_operator"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.cross_product_operator">[docs]</a><span class="k">def</span> <span class="nf">cross_product_operator</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a cross product operator for the given vector.&quot;&quot;&quot;</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                  <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                  <span class="p">[</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">S</span></div>


<div class="viewcode-block" id="Vehicle"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle">[docs]</a><span class="k">class</span> <span class="nc">Vehicle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Vehicle interface to be used by model-based controllers. It receives the</span>
<span class="sd">    parameters necessary to compute the vehicle&#39;s motion according to Fossen&#39;s.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">INSTANCE</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inertial_frame_id</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class constructor.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">inertial_frame_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;world_ned&#39;</span><span class="p">]</span>
        <span class="c1"># Reading current namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_namespace</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inertial_frame_id</span> <span class="o">=</span> <span class="n">inertial_frame_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body_frame_id</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inertial_frame_id</span> <span class="o">==</span> <span class="s1">&#39;world&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_body_frame_id</span> <span class="o">=</span> <span class="s1">&#39;base_link&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_body_frame_id</span> <span class="o">=</span> <span class="s1">&#39;base_link_ned&#39;</span>

        <span class="n">tf_buffer</span> <span class="o">=</span> <span class="n">tf2_ros</span><span class="o">.</span><span class="n">Buffer</span><span class="p">()</span>
        <span class="n">listener</span> <span class="o">=</span> <span class="n">tf2_ros</span><span class="o">.</span><span class="n">TransformListener</span><span class="p">(</span><span class="n">tf_buffer</span><span class="p">)</span>
        <span class="n">tf_trans_ned_to_enu</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tf_trans_ned_to_enu</span> <span class="o">=</span> <span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
                <span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;world_ned&#39;</span><span class="p">,</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Time</span><span class="p">(),</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No transform found between world and the &#39;</span>
                               <span class="s1">&#39;world_ned &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform_ned_to_enu</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">tf_trans_ned_to_enu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform_ned_to_enu</span> <span class="o">=</span> <span class="n">quaternion_matrix</span><span class="p">(</span>
                <span class="p">(</span><span class="n">tf_trans_ned_to_enu</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                 <span class="n">tf_trans_ned_to_enu</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                 <span class="n">tf_trans_ned_to_enu</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                 <span class="n">tf_trans_ned_to_enu</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">w</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Transform world_ned (NED) to world (ENU)=</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_ned_to_enu</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~mass&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~mass&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Mass has to be positive&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ixx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">iyy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">izz</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ixy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ixz</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">iyz</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~inertial&#39;</span><span class="p">):</span>
            <span class="k">print</span> <span class="s1">&#39;has inertial&#39;</span>
            <span class="n">inertial</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~inertial&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inertial</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid moments of inertia&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span> <span class="o">=</span> <span class="n">inertial</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cog</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~cog&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cog</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~cog&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cog</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid center of gravity vector&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cob</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~cog&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cob</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~cob&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cob</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid center of buoyancy vector&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_body_frame</span> <span class="o">=</span> <span class="s1">&#39;base_link&#39;</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~base_link&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_body_frame</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~base_link&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_volume</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~volume&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_volume</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~volume&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_volume</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid volume&#39;</span><span class="p">)</span>

        <span class="c1"># Fluid density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_density</span> <span class="o">=</span> <span class="mf">1028.0</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~density&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_density</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~density&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_density</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid fluid density&#39;</span><span class="p">)</span>

        <span class="c1"># Bounding box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_height</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_width</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~height&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_height</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~height&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_height</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid height&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~length&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~length&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid length&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~width&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_width</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~width&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_width</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid width&#39;</span><span class="p">)</span>


        <span class="c1"># Calculating the rigid-body mass matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">*</span> \
            <span class="n">cross_product_operator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">*</span> \
            <span class="n">cross_product_operator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_M</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_inertial_tensor</span><span class="p">()</span>

        <span class="c1"># Loading the added-mass matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~Ma&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~Ma&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ma</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Invalid added mass matrix&#39;</span><span class="p">)</span>

        <span class="c1"># Sum rigid-body and added-mass matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_mass_matrix</span><span class="p">()</span>

        <span class="c1"># Acceleration of gravity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">=</span> <span class="mf">9.81</span>

        <span class="c1"># Initialize the Coriolis and centripetal matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Vector of restoring forces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="c1"># Loading the linear damping coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~linear_damping&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~linear_damping&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Linear damping must be given as a 6x6 matrix or the diagonal coefficients&#39;</span><span class="p">)</span>

        <span class="c1"># Loading the nonlinear damping coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quad_damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~quad_damping&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_quad_damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~quad_damping&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad_damping</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Quadratic damping must be given defined with 6 coefficients&#39;</span><span class="p">)</span>

        <span class="c1"># Loading the linear damping coefficients proportional to the forward speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping_forward_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">has_param</span><span class="p">(</span><span class="s1">&#39;~linear_damping_forward_speed&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping_forward_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;~linear_damping_forward_speed&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping_forward_speed</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping_forward_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping_forward_speed</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping_forward_speed</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Linear damping proportional to the forward speed must be given as a 6x6 &#39;</span>
                                         <span class="s1">&#39;matrix or the diagonal coefficients&#39;</span><span class="p">)</span>

        <span class="c1"># Initialize damping matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Vehicle states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                          <span class="n">rot</span><span class="o">=</span><span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># Velocity in the body frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="c1"># Acceleration in the body frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="c1"># Generalized forces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gen_forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>        

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Vehicle.q_to_matrix"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.q_to_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">q_to_matrix</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">e3</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">e3</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                       <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1</span> <span class="o">*</span> <span class="n">e2</span> <span class="o">-</span> <span class="n">e3</span> <span class="o">*</span> <span class="n">eta</span><span class="p">),</span>
                       <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1</span> <span class="o">*</span> <span class="n">e3</span> <span class="o">+</span> <span class="n">e2</span> <span class="o">*</span> <span class="n">eta</span><span class="p">)],</span>
                      <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1</span> <span class="o">*</span> <span class="n">e2</span> <span class="o">+</span> <span class="n">e3</span> <span class="o">*</span> <span class="n">eta</span><span class="p">),</span>
                       <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">e3</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                       <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e2</span> <span class="o">*</span> <span class="n">e3</span> <span class="o">-</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">eta</span><span class="p">)],</span>
                      <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1</span> <span class="o">*</span> <span class="n">e3</span> <span class="o">-</span> <span class="n">e2</span> <span class="o">*</span> <span class="n">eta</span><span class="p">),</span>
                       <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e2</span> <span class="o">*</span> <span class="n">e3</span> <span class="o">+</span> <span class="n">e1</span> <span class="o">*</span> <span class="n">eta</span><span class="p">),</span>
                       <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">e2</span><span class="o">**</span><span class="mi">2</span><span class="p">)]])</span>
        <span class="k">return</span> <span class="n">R</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return robot namespace.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">body_frame_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_body_frame_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inertial_frame_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inertial_frame_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_volume</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gravity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_density</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_height</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_width</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_length</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the position of the vehicle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>

    <span class="nd">@pos.setter</span>
    <span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Invalid position vector&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">depth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return depth of the vehicle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">heading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the heading of the vehicle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">euler</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">quat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return orientation quaternion.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">])</span>

    <span class="nd">@quat.setter</span>
    <span class="k">def</span> <span class="nf">quat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="n">q_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q_rot</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Invalid quaternion&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_rot</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">quat_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the time derivative of the quaternion vector.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TBtoIquat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return linear and angular velocity vector.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="p">)</span>

    <span class="nd">@vel.setter</span>
    <span class="k">def</span> <span class="nf">vel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">velocity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the velocity vector in the BODY frame.&quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Invalid velocity vector&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vel</span> <span class="o">=</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return linear and angular acceleration vector.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_acc</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">euler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return orientation in Euler angles as described in Fossen, 2011.&quot;&quot;&quot;</span>
        <span class="c1"># Rotation matrix from BODY to INERTIAL</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotBtoI</span>
        <span class="c1"># Roll</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="c1"># Pitch, treating singularity cases</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pitch</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">den</span><span class="p">))</span>
        <span class="c1"># Yaw</span>
        <span class="n">yaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">rot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">rot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">euler_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return time derivative of the Euler angles.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TItoBeuler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">restoring_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the restoring force vector.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_restoring</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_g</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Mtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Ctotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Dtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pose_euler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return pose as a vector, orientation in Euler angles.&quot;&quot;&quot;</span>
        <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euler</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">pose</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">pose</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">roll</span>
        <span class="n">pose</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitch</span>
        <span class="n">pose</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">yaw</span>
        <span class="k">return</span> <span class="n">pose</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pose_quat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return pose as a vector, orientation as quaternion.&quot;&quot;&quot;</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">pose</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">pose</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quat</span>
        <span class="k">return</span> <span class="n">pose</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rotItoB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return rotation from INERTIAL to BODY frame&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotBtoI</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rotBtoI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return rotation from BODY to INERTIAL frame using the zyx convention</span>
<span class="sd">           to retrieve Euler angles from the quaternion vector (Fossen, 2011).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the (x, y, z, w) format to describe quaternions</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_to_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">TItoBeuler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euler</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">p</span><span class="p">)],</span>
                      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)],</span>
                      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">)]])</span>
        <span class="k">return</span> <span class="n">T</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">TBtoIeuler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euler</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">p</span><span class="p">)],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">)]])</span>
        <span class="k">return</span> <span class="n">T</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">TBtoIquat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return matrix for transformation of BODY-fixed angular velocities in the</span>
<span class="sd">        BODY frame in relation to the INERTIAL frame into quaternion rate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">e3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="o">-</span><span class="n">e1</span><span class="p">,</span> <span class="o">-</span><span class="n">e2</span><span class="p">,</span> <span class="o">-</span><span class="n">e3</span><span class="p">],</span>
             <span class="p">[</span><span class="n">eta</span><span class="p">,</span> <span class="o">-</span><span class="n">e3</span><span class="p">,</span> <span class="n">e2</span><span class="p">],</span>
             <span class="p">[</span><span class="n">e3</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="o">-</span><span class="n">e1</span><span class="p">],</span>
             <span class="p">[</span><span class="o">-</span><span class="n">e2</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">eta</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span>

<div class="viewcode-block" id="Vehicle.to_SNAME"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.to_SNAME">[docs]</a>    <span class="k">def</span> <span class="nf">to_SNAME</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_body_frame_id</span> <span class="o">==</span> <span class="s1">&#39;base_link_ned&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                 <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid input vector, v=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Message=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Vehicle.from_SNAME"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.from_SNAME">[docs]</a>    <span class="k">def</span> <span class="nf">from_SNAME</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_body_frame_id</span> <span class="o">==</span> <span class="s1">&#39;base_link_ned&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_SNAME</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="Vehicle.print_info"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.print_info">[docs]</a>    <span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the vehicle&#39;s parameters.&quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s1">&#39;Namespace: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;Mass: {0:.3f} kg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;System inertia matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span>
        <span class="k">print</span> <span class="s1">&#39;Added-mass:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ma</span>
        <span class="k">print</span> <span class="s1">&#39;M:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span>
        <span class="k">print</span> <span class="s1">&#39;Linear damping:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span>
        <span class="k">print</span> <span class="s1">&#39;Quad. damping:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad_damping</span>
        <span class="k">print</span> <span class="s1">&#39;Center of gravity:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cog</span>
        <span class="k">print</span> <span class="s1">&#39;Center of buoyancy:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cob</span>
        <span class="k">print</span> <span class="s1">&#39;Inertial:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_inertial_tensor</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_calc_mass_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_M</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ma</span>

    <span class="k">def</span> <span class="nf">_update_coriolis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Velocity vector has the wrong &#39;</span>
                                         <span class="s1">&#39;dimension&#39;</span><span class="p">)</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">vel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_SNAME</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">S_12</span> <span class="o">=</span> <span class="o">-</span> <span class="n">cross_product_operator</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">nu</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">nu</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>
        <span class="n">S_22</span> <span class="o">=</span> <span class="o">-</span> <span class="n">cross_product_operator</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">nu</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">nu</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_22</span>

    <span class="k">def</span> <span class="nf">_update_damping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Velocity vector has the wrong &#39;</span>
                                         <span class="s1">&#39;dimension&#39;</span><span class="p">)</span>
            <span class="c1"># Assume the input velocity is already given in the SNAME convention</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">vel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_SNAME</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_D</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span> <span class="o">-</span> <span class="n">nu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping_forward_speed</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad_damping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_calc_inertial_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;ixx&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;ixy&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;ixz&#39;</span><span class="p">]],</span>
             <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;ixy&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;iyy&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;iyz&#39;</span><span class="p">]],</span>
             <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;ixz&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;iyz&#39;</span><span class="p">],</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_inertial</span><span class="p">[</span><span class="s1">&#39;izz&#39;</span><span class="p">]]])</span>

    <span class="k">def</span> <span class="nf">_update_restoring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_sname</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the restoring forces for the current orientation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_sname</span><span class="p">:</span>
            <span class="n">Fg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span><span class="p">])</span>
            <span class="n">Fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_density</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Fg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span><span class="p">])</span>
            <span class="n">Fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gravity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_density</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rotItoB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_to_matrix</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rotItoB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotItoB</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_g</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotItoB</span><span class="p">,</span> <span class="n">Fg</span> <span class="o">+</span> <span class="n">Fb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_g</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotItoB</span><span class="p">,</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cog</span><span class="p">,</span> <span class="n">Fg</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cob</span><span class="p">,</span> <span class="n">Fb</span><span class="p">))</span>        

<div class="viewcode-block" id="Vehicle.set_added_mass"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.set_added_mass">[docs]</a>    <span class="k">def</span> <span class="nf">set_added_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set added-mass matrix coefficients.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Ma</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="k">print</span> <span class="s2">&quot;Added mass matrix must have dimensions 6x6&quot;</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ma</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_mass_matrix</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Vehicle.set_damping_coef"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.set_damping_coef">[docs]</a>    <span class="k">def</span> <span class="nf">set_damping_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_damping</span><span class="p">,</span> <span class="n">quad_damping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set linear and quadratic damping coefficients.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">linear_damping</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">quad_damping</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Invalid dimensions for damping coefficient vectors&#39;</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_linear_damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">linear_damping</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quad_damping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">quad_damping</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Vehicle.compute_force"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.compute_force">[docs]</a>    <span class="k">def</span> <span class="nf">compute_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">with_restoring</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_sname</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the sum of forces acting on the vehicle.</span>

<span class="sd">        Given acceleration and velocity vectors, this function returns the</span>
<span class="sd">        sum of forces given the rigid-body and hydrodynamic models for the</span>
<span class="sd">        marine vessel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">acc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acc</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Acceleration vector must have 6 &#39;</span>
                                         <span class="s1">&#39;elements&#39;</span><span class="p">)</span>
            <span class="c1"># It is assumed the input acceleration is given in the SNAME convention</span>
            <span class="n">nu_dot</span> <span class="o">=</span> <span class="n">acc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert the acceleration vector to the SNAME convention since the odometry is usually given using the</span>
            <span class="c1"># ENU convention</span>
            <span class="n">nu_dot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_SNAME</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_acc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vel</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;Velocity vector must have 6 &#39;</span>
                                         <span class="s1">&#39;elements&#39;</span><span class="p">)</span>
            <span class="c1"># It is assumed the input velocity is given in the SNAME convention</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">vel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_SNAME</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_damping</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_coriolis</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_restoring</span><span class="p">(</span><span class="n">use_sname</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_restoring</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_g</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span><span class="p">,</span> <span class="n">nu_dot</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span> <span class="o">+</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span> <span class="o">+</span> <span class="n">g</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_sname</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_SNAME</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="Vehicle.compute_acc"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.compute_acc">[docs]</a>    <span class="k">def</span> <span class="nf">compute_acc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen_forces</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_sname</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate inverse dynamics to obtain the acceleration vector.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gen_forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">gen_forces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># It is assumed the generalized forces are given in the SNAME convention</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gen_forces</span> <span class="o">=</span> <span class="n">gen_forces</span>
        <span class="c1"># Check if the mass and inertial parameters were set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_SNAME</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vel</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_update_damping</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_coriolis</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_restoring</span><span class="p">(</span><span class="n">use_sname</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c1"># Compute the vehicle&#39;s acceleration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Mtotal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_forces</span> <span class="o">-</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span> <span class="o">-</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_D</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span> <span class="o">-</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_g</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_sname</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_SNAME</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_acc</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acc</span></div>

<div class="viewcode-block" id="Vehicle.get_jacobian"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.get_jacobian">[docs]</a>    <span class="k">def</span> <span class="nf">get_jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the Jacobian for the current orientation using transformations</span>
<span class="sd">        from BODY to INERTIAL frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="c1"># Build the Jacobian matrix</span>
        <span class="n">jac</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotBtoI</span>
        <span class="n">jac</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TBtoIeuler</span>
        <span class="k">return</span> <span class="n">jac</span></div>
    
<div class="viewcode-block" id="Vehicle.update_odometry"><a class="viewcode-back" href="../../api/uuv_simulator/uuv_trajectory_control/src/uuv_control_interfaces.html#uuv_control_interfaces.vehicle.Vehicle.update_odometry">[docs]</a>    <span class="k">def</span> <span class="nf">update_odometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Odometry topic subscriber callback function.&quot;&quot;&quot;</span>
        <span class="c1"># The frames of reference delivered by the odometry seems to be as</span>
        <span class="c1"># follows</span>
        <span class="c1"># position -&gt; world frame</span>
        <span class="c1"># orientation -&gt; world frame</span>
        <span class="c1"># linear velocity -&gt; world frame</span>
        <span class="c1"># angular velocity -&gt; world frame</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inertial_frame_id</span> <span class="o">!=</span> <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ROSException</span><span class="p">(</span><span class="s1">&#39;The inertial frame ID used by the &#39;</span>
                                     <span class="s1">&#39;vehicle model does not match the &#39;</span>
                                     <span class="s1">&#39;odometry frame ID, vehicle=</span><span class="si">%s</span><span class="s1">, odom=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inertial_frame_id</span><span class="p">,</span>
                                      <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span><span class="p">))</span>

        <span class="c1"># Update the velocity vector</span>
        <span class="c1"># Update the pose in the inertial frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                      <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                      <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>

        <span class="c1"># Using the (x, y, z, w) format for quaternions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pose</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                      <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                      <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                                      <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="p">])</span>
        <span class="c1"># Linear velocity on the INERTIAL frame</span>
        <span class="n">lin_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                            <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                            <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
        <span class="c1"># Transform linear velocity to the BODY frame</span>
        <span class="n">lin_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotItoB</span><span class="p">,</span> <span class="n">lin_vel</span><span class="p">)</span>
        <span class="c1"># Angular velocity in the INERTIAL frame</span>
        <span class="n">ang_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                            <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                            <span class="n">msg</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
        <span class="c1"># Transform angular velocity to BODY frame</span>
        <span class="n">ang_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotItoB</span><span class="p">,</span> <span class="n">ang_vel</span><span class="p">)</span>
        <span class="c1"># Store velocity vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">lin_vel</span><span class="p">,</span> <span class="n">ang_vel</span><span class="p">))</span></div></div>

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, UUV Simulator Authors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>